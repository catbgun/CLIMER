---
title: "220602_CLIMER_TFF"
author: "CBG"
date: "2 6 2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

*Installation of packages* 
```{r}
#install.packages(c("ggplot2", "lubridate", "scales", "plyr"))
Packages <- c("ggplot2", "lubridate", "scales", "plyr", "dplyr", "Rmisc")
lapply(Packages, library, character.only = TRUE)
```

### Load Data
```{r Load file}
d1 <- read.table("CLIMER TFF R COMPLETE.txt", sep = "\t", header = TRUE, fill=TRUE)
```

### Data preparation
- recognize date as date
```{r Data preparation}
d1$Date <- as.Date(d1$Date,format = "%d.%m.%Y")
d1$Month <- month(d1$Date, label=TRUE) #Not working, find other way from other projects
d1$year <- year(d1$Date) #Not working, find other way from other projects

dx <- subset(d1, Position!="Hypolimnion")

unique(dx$Position)
dx$Position <- factor(dx$Position,
                      levels = c("Inlet", "Outlet"),ordered = TRUE)
dx$Size <- factor(dx$Size,
                  levels = c("LMW", "HMW"),ordered = TRUE)
dx$Date <- factor(dx$Date,
                  levels = c("15.09.2016", "25.01.2017", "01.04.2017", "06.06.2017", "22.09.2017", 
                             "29.05.2018", "20.09.2018","17.10.2018", "21.05.2019", "07.06.2019"),ordered = TRUE)

```
Summary 
```{r}

#dz <- na.omit(dx)
dx %>% 
  group_by(Size) %>% 
    summarize(
    avg_TOC = mean(DOC_UiO),
    sd_TOC = sd(DOC_UiO),
    avg_THg = mean(na.omit(THg)),
    sd_THg = sd(na.omit(THg)),
    avg_THgDOC = mean(na.omit(THg_DOC)),
    sd_THgDOC = sd(na.omit(THg_DOC)),
    avg_sUVa = mean(sUVa),
    sd_sUVa = sd(sUVa),
    avg_pH = mean(pH),
    sd_pH = sd(pH)
)


```

Statistics
https://www.datanovia.com/en/blog/how-to-perform-t-test-for-multiple-groups-in-r/
t test for two groups (ANOVA from additional groups)
should use unparied/independent t-test
two-sample test since comparing two samples/groups
two-tailed test for asking if there is a difference or not
```{r}
# Load required R packages
library(tidyverse)
library(rstatix)
library(ggpubr)
#STATISTICAL TESTING

# Pairwise comparisons
pwc <- dx %>%
  pairwise_t_test(THg_DOC ~ Size, paired=FALSE, alternative= "two.sided")
pwc

pwc <- dx %>%
  pairwise_t_test(sUVa ~ Size, paired=FALSE, alternative= "two.sided")
pwc



#t.test(LMW~HMW, mu=0, alt="two.sided", conf=0.95, var.eq=F, paired=F)
#res.aov <- aov(dx$THGTOC_m ~ dx$Station, data = dx)
# Summary of the analysis
#summary(res.aov)
#TukeyHSD(res.aov)

```


#1) Boxplot
- look for differences between LMW and HMW optical properties

```{r Boxplot}
ggplot(dx, aes(x=Size, y= DOC_UiO))+
  geom_boxplot()
  facet_grid(.~Position)

```

#1.1 Correlation scatter plot
```{r}
#d <- subset(d, Lake == "Inlet"| Lake =="Outlet")
#d <- subset(d, Fraction == "LMW"| Fraction =="HMW")
head(dx)
#IMPORTANT!!! Correlation plot for biodeg and parameters
ggplot(dx, aes(sUVa, THg_DOC))+
  geom_point(aes(colour=interaction(factor(Size))), size=6)+
  geom_smooth(method = "lm", se = FALSE, colour="black")+
  theme(axis.text.y = element_text(size= 22),
        axis.title.x = element_text(size = 24, margin=margin(20,0,0,0)),
        axis.title.y = element_text(size = 24, margin=margin(0,20,0,0)),
        strip.text.x = element_text(size = 32),
        axis.text.x = element_text(angle=0, hjust=0.5, vjust=0, size = 24),
        plot.title=element_text(size=30, face="bold"),
        legend.text=element_text(size=26),
        legend.title = element_blank())+
  facet_grid(. ~ factor(Position))

labs(title = "DOM Size and Aromaticity", x = "sUVa (Abs254:DOC*100)", y = "Rate of DOC decay:DOC (/h)")
ylim(0, -0.007)+
  scale_colour_manual(values=c("#F8766D", "#7CAE00", "#00BFC4"))+
  xlim(0, 8)
```

#2) Barplplot
- look for seasonal differences in the distribution between LMW and HMW
```{r}
LMW <- subset(d1, Size=LMW)
ggplot(d1, aes(x=Date, y=sUVa, fill=Months))+
  geom_bar(position="dodge", stat="identity")+
  facet_grid(Size~.)

```

#2) Barplot: seasonal, relative. Muligens det samme som i punkt 3...
- make summrary before plotting
```{r}
dx <- na.omit(d1)
DOC <- select(d1, DOC_frac, Size, Position)
Hg <- select(d1, THg, MeHg, THg_DOC, MeHg_DOC, Size, Position)

d <- summarySE(Hg, measurevar="THg_DOC", groupvar=c("Position", "Size"))
head(d)

ggplot(d1, aes(x=Position, y=THg_DOC, fill=factor(Size))) + 
  geom_bar(stat="identity", position=position_dodge())
theme(axis.text.y = element_text(size= 20, colour="black"),
      axis.title.x = element_text(size = 20, margin=margin(20,0,0,0)),
      axis.title.y = element_text(size = 24, margin=margin(0,20,0,0)),
      strip.text.x = element_text(size = 26),
      axis.text.x = element_text(angle=0, vjust=1, size = 24, colour="black"),
      plot.title=element_text(size=30))+
  labs(title = "MeHg/DOC", x = "", y = "MeHg:DOC (ng/mg)")+
  geom_errorbar(aes(ymin=MeHg_DOC-sd, ymax=MeHg_DOC+sd), position=position_dodge(0.9),
                width=.2, col="black")
```

#2) VELDIG BRA BAR FOR TID PÅ X-AKSE 

```{r}
#for the facet, the side of the variable you put the .~ determined if vertical or horisontal
dx$Date = as.Date(dx$Date)
HMW<- subset(d1, Size == "HMW")
LMW<- subset(d1, Size == "LMW")
#|Position == "Hypolimnion"
#See all data next to each other either with natural or compressed x-axis
ggplot(data = subset(d1, Position == "Inlet"|Position == "Outlet"),
       aes(y=DOC, x=Date, fill=(factor(Position))))+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  geom_bar(position=position_dodge(), stat="identity", size=1, linetype="dashed")+
  facet_grid(Size~., scale="free")
ggtitle("sUVa")

```


# 3) For å se om forskjeller i gjennomsnitt mellom inlet, hypo og outlet. Lager et sammendrag først og så plottes det

```{r}
library(Rmisc)
head(dx)
dx =na.omit(dx)
ds <- summarySE(dx, measurevar="sUVa", groupvar=c("Size", "Position"))
head(ds)
length(dx$Position)

head(ds)
# Convert dose to a factor variable
df2$dose=as.factor(df2$dose)

ggplot(ds, aes(x=factor(Position), y=Labile)) + 
  geom_bar(stat="identity", position=position_dodge())+
  geom_errorbar(aes(ymin=Labile-sd, ymax=Labile+sd), width=0.2, position=position_dodge(.9))+
  facet_grid(. ~ factor(Size))

```

#4) #4) Correlation plots 
#Correlation plots, LMW/HMW, and INlet/Outlet
```{r}
d <- subset(d, Lake == "Inlet"| Lake =="Outlet")
d <- subset(d, Fraction == "LMW"| Fraction =="HMW")
head(dx)
#IMPORTANT!!! Correlation plot for biodeg and parameters
ggplot(dx, aes(DOC_natural, DOC_TFF))+
  geom_point(aes(colour=interaction(factor(Size))), size=6)+
  geom_smooth(method = "lm", se = FALSE, colour="black")+
  facet_grid(. ~ factor(Position))+
  theme(axis.text.y = element_text(size= 22),
        axis.title.x = element_text(size = 24, margin=margin(20,0,0,0)),
        axis.title.y = element_text(size = 24, margin=margin(0,20,0,0)),
        strip.text.x = element_text(size = 32),
        axis.text.x = element_text(angle=0, hjust=0.5, vjust=0, size = 24),
        plot.title=element_text(size=30, face="bold"),
        legend.text=element_text(size=26),
        legend.title = element_blank())
labs(title = "DOM Size and Aromaticity", x = "sUVa (Abs254:DOC*100)", y = "Rate of DOC decay:DOC (/h)")
ylim(0, -0.007)+
  scale_colour_manual(values=c("#F8766D", "#7CAE00", "#00BFC4"))+
  xlim(0, 8)
```

## Biodegradation data
```{r}
b1 <- read.table("Copy of Climer_Biodeg_3.txt", sep = "\t", header = TRUE, fill=TRUE)

b2 <- subset(b1, Lake!="Hypolimnion")
b3<-subset(b2,Fraction!="Bulk")



#Rate.DOC.ave
ggplot(b2, aes(x=Fraction, y= Rate.DOC.ave, fill=Fraction))+
  geom_boxplot()+
  facet_grid(.~Lake)+
  scale_y_reverse() 


ggplot(LM, aes(x=Fraction, y= Rate.DOC.ave, fill=Fraction))+
  geom_boxplot()+
  facet_grid(.~Lake)+
  scale_y_reverse() 
 

ggplot(b3, aes(x=Fraction, y= Rel.rate.DOC))+
  geom_boxplot()+
  facet_grid(.~Lake)

ggplot(b3, aes(x=Lake, y= Rate.DOC.ave, fill=Lake))+
  geom_boxplot()+
  facet_grid(.~Fraction)+
  scale_y_reverse() 

ggplot(b2, aes(x=Lake, y= Rate.DOC.ave, fill=Lake))+
  geom_boxplot()+
  facet_grid(.~Fraction)

```

## Correlation plots with biodeg data

#Correlation plots, LMW/HMW, and INlet/Outlet

```{r}
# GET EQUATION AND R-SQUARED AS STRING
# SOURCE: https://groups.google.com/forum/#!topic/ggplot2/1TgH-kG5XMA

lm_eqn <- function(df){
    m <- lm(y ~ x, df);
    eq <- substitute(italic(y) == a + b %.% italic(x)*","~~italic(r)^2~"="~r2, 
         list(a = format(unname(coef(m)[1]), digits = 2),
              b = format(unname(coef(m)[2]), digits = 2),
             r2 = format(summary(m)$r.squared, digits = 3)))
    as.character(as.expression(eq));
}

#p1 <- p + geom_text(x = 25, y = 300, label = lm_eqn(df), parse = TRUE)
```

```{r Correlation biodeg data}
library(ggpubr)

LM <- subset(b3, Fraction=="LMW")
HM <- subset(b3, Fraction=="HMW")

ggplot(b3, aes(sUVa, Rate.DOC.ave))+
  geom_point(size=6, aes(shape=Fraction))+
  geom_smooth(method = "lm", se = FALSE, colour="black")+
  stat_regline_equation(label.x=0.35, label.y=-0.012) +
  stat_cor(aes(label=..rr.label..), label.x=0.35, label.y=-0.013)+
  theme(axis.text.y = element_text(size= 22),
        axis.title.x = element_text(size = 24, margin=margin(20,0,0,0)),
        axis.title.y = element_text(size = 24, margin=margin(0,20,0,0)),
        strip.text.x = element_text(size = 32),
        axis.text.x = element_text(angle=0, hjust=0.5, vjust=0, size = 24),
        plot.title=element_text(size=30, face="bold"),
        legend.text=element_text(size=26),
        legend.title = element_blank())+
    facet_grid(.~Lake)


  
  #  facet_grid(Lake ~ Fraction, scales="free")
labs(title = "DOM Size and Aromaticity", x = "sUVa (Abs254:DOC*100)", y = "Rate of DOC decay:DOC (/h)")
ylim(0, -0.007)+
  scale_colour_manual(values=c("#F8766D", "#7CAE00", "#00BFC4"))+
  xlim(0, 8)
```

# Biodeg correlation plot
```{r}
class(b2$sUVa)
library(dplyr)
b2x <- na.omit(b2$Rate.DOC.ave)

correlation_by_group <- b2x %>%
  group_by(Lake, Fraction) %>%
  summarise(correlation = cor(Rate.DOC.ave, sUVa))

# Print the result
print(correlation_by_group)
```

