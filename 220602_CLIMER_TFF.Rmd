---
title: "220602_CLIMER_TFF"
author: "CBG"
date: "2 6 2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

*Installation of packages* 
```{r}
#install.packages(c("ggplot2", "lubridate", "scales", "plyr"))
Packages <- c("ggplot2", "lubridate", "scales", "plyr", "dplyr", "Rmisc", "ggpubr")
lapply(Packages, library, character.only = TRUE)
```

### Load Data
```{r Load file}
d1 <- read.table("CLIMER TFF R COMPLETE.txt", sep = "\t", header = TRUE, fill=TRUE)
```

### Data preparation
- recognize date as date
```{r Data preparation}
d1$Date <- as.Date(d1$Date,format = "%d.%m.%Y")
d1$Month <- month(d1$Date, label=TRUE) #Not working, find other way from other projects
d1$year <- year(d1$Date) #Not working, find other way from other projects

dx <- subset(d1, Position!="Hypolimnion")

unique(dx$Position)
dx$Position <- factor(dx$Position,
                      levels = c("Inlet", "Outlet"),ordered = TRUE)
dx$Size <- factor(dx$Size,
                  levels = c("LMW", "HMW"),ordered = TRUE)
dx$Date <- factor(dx$Date,
                  levels = c("15.09.2016", "25.01.2017", "01.04.2017", "06.06.2017", "22.09.2017", 
                             "29.05.2018", "20.09.2018","17.10.2018", "21.05.2019", "07.06.2019"),ordered = TRUE)

```
Summary 
```{r}

#dz <- na.omit(dx)
dx %>% 
  group_by(Size) %>% 
    summarize(
    avg_TOC = mean(DOC_UiO),
    sd_TOC = sd(DOC_UiO),
    avg_THg = mean(na.omit(THg)),
    sd_THg = sd(na.omit(THg)),
    avg_THgDOC = mean(na.omit(THg_DOC)),
    sd_THgDOC = sd(na.omit(THg_DOC)),
    avg_sUVa = mean(sUVa),
    sd_sUVa = sd(sUVa),
    avg_pH = mean(pH),
    sd_pH = sd(pH)
)


```

Statistics
https://www.datanovia.com/en/blog/how-to-perform-t-test-for-multiple-groups-in-r/
t test for two groups (ANOVA from additional groups)
should use unparied/independent t-test
two-sample test since comparing two samples/groups
two-tailed test for asking if there is a difference or not
```{r Normality testing}
LMW <- subset(dx, Size == "LMW")
HMW <- subset(dx, Size == "HMW")

#Visual inspection: density plot and QQ plot
ggdensity(LMW$THg_DOC, 
          main = "Density plot of tooth length",
          xlab = "Tooth length")

ggdensity(HMW$THg_DOC, 
          main = "Density plot of tooth length",
          xlab = "Tooth length")

ggqqplot(LMW$THg_DOC)
ggqqplot(HMW$THg_DOC)

#Normality test
shapiro.test(LMW$THg_DOC)
shapiro.test(HMW$THg_DOC)

```

```{r Normality testing}
LMW <- subset(dx, Size == "LMW")
HMW <- subset(dx, Size == "HMW")

#Visual inspection: density plot and QQ plot
ggdensity(LMW$sUVa, 
          main = "Density plot of tooth length",
          xlab = "Tooth length")

ggdensity(HMW$sUVa, 
          main = "Density plot of tooth length",
          xlab = "Tooth length")

ggqqplot(LMW$sUVa)
ggqqplot(HMW$sUVa)

#Normality test
shapiro.test(LMW$sUVa)
shapiro.test(HMW$sUVa)

```

```{r Normality testing}
LMW <- subset(dx, Size == "LMW")
HMW <- subset(dx, Size == "HMW")

#Visual inspection: density plot and QQ plot
ggdensity(LMW$E2_E3, 
          main = "Density plot of tooth length",
          xlab = "Tooth length")

ggdensity(HMW$E2_E3, 
          main = "Density plot of tooth length",
          xlab = "Tooth length")

ggqqplot(LMW$E2_E3)
ggqqplot(HMW$E2_E3)

#Normality test
shapiro.test(LMW$E2_E3)
shapiro.test(HMW$E2_E3)

```

```{r Normality testing}
LMW <- subset(dx, Size == "LMW")
HMW <- subset(dx, Size == "HMW")

#Visual inspection: density plot and QQ plot
ggdensity(LMW$THg_DOC, 
          main = "Density plot of tooth length",
          xlab = "Tooth length")

ggdensity(HMW$THg_DOC, 
          main = "Density plot of tooth length",
          xlab = "Tooth length")

ggqqplot(LMW$THg_DOC)
ggqqplot(HMW$THg_DOC)

#Normality test
shapiro.test(LMW$THg_DOC)
shapiro.test(HMW$THg_DOC)

```


Number of observations < 30 and most failing the normality test. 
At .05 significance level, we conclude that the gas mileage data of manual and automatic transmissions in mtcar are nonidentical populations (if p-value < 0.05).
http://www.sthda.com/english/wiki/unpaired-two-samples-wilcoxon-test-in-r
```{r}
#"two.sided" (default),
wilcox.test(THg_DOC ~ Size, data=dx) 
wilcox.test(sUVa ~ Size, data=dx)
wilcox.test(E2_E3 ~ Size, data=dx)

HMW <- subset(dx, Size =="HMW")

#Visualise boxplot
library("ggpubr")
class(HMW$sUVa)
ggboxplot(HMW, x = "Position", y = "E2_E3", 
          color = "Position", palette = c("#00AFBB", "#E7B800"),
          ylab = "Weight", xlab = "Groups")

wilcox.test(E2_E3 ~ Position, data=HMW)

```




```{r}
# Load required R packages
library(tidyverse)
library(rstatix)
library(ggpubr)
#STATISTICAL TESTING

#Bulk er dessverre ikke med i datasettet her, kun i biodeg-dataene. Men vi kan henvise til verdier i appendiks. 
# Pairwise comparisons

length(LMW$THg_DOC)
length(HMW$THg_DOC)
length(LMW$sUVa)
length(HMW$sUVa)
length(LMW$E2_E3)
length(HMW$E2_E3)

#t.test(LMW~HMW, mu=0, alt="two.sided", conf=0.95, var.eq=F, paired=F)
#res.aov <- aov(dx$THGTOC_m ~ dx$Station, data = dx)
# Summary of the analysis
#summary(res.aov)
#TukeyHSD(res.aov)

```

Correlation plots
```{r}
library("ggpubr")
head(dx)

#dy<-dx[!(dx$Year=="2016"),]

ggscatter(dx, x = "sUVa", y = "THg" , 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab ="" , ylab ="")+
  facet_grid(.~Size)
```


#1) Boxplot
- look for differences between LMW and HMW optical properties
```{r Boxplot}
ggplot(dx, aes(x=Size, y= DOC_UiO))+
  geom_boxplot()
  facet_grid(.~Position)

```

#1.1 Correlation scatter plot
```{r}
#d <- subset(d, Lake == "Inlet"| Lake =="Outlet")
#d <- subset(d, Fraction == "LMW"| Fraction =="HMW")
head(dx)
#IMPORTANT!!! Correlation plot for biodeg and parameters
ggplot(dx, aes(DOC_UiO, THg))+
  geom_point(aes(colour=interaction(factor(Size))), size=6)+
  geom_smooth(method = "lm", se = FALSE, colour="black")+
  theme(axis.text.y = element_text(size= 22),
        axis.title.x = element_text(size = 24, margin=margin(20,0,0,0)),
        axis.title.y = element_text(size = 24, margin=margin(0,20,0,0)),
        strip.text.x = element_text(size = 32),
        axis.text.x = element_text(angle=0, hjust=0.5, vjust=0, size = 24),
        plot.title=element_text(size=30, face="bold"),
        legend.text=element_text(size=26),
        legend.title = element_blank())+
  facet_grid(. ~ factor(Position))

labs(title = "DOM Size and Aromaticity", x = "sUVa (Abs254:DOC*100)", y = "Rate of DOC decay:DOC (/h)")
ylim(0, -0.007)+
  scale_colour_manual(values=c("#F8766D", "#7CAE00", "#00BFC4"))+
  xlim(0, 8)
```

#2) Barplplot
- look for seasonal differences in the distribution between LMW and HMW
```{r}
LMW <- subset(d1, Size=LMW)
ggplot(d1, aes(x=Date, y=sUVa, fill=Months))+
  geom_bar(position="dodge", stat="identity")+
  facet_grid(Size~.)

```

#2) Barplot: seasonal, relative. Muligens det samme som i punkt 3...
- make summrary before plotting
```{r}
dx <- na.omit(d1)
DOC <- select(d1, DOC_frac, Size, Position)
Hg <- select(d1, THg, MeHg, THg_DOC, MeHg_DOC, Size, Position)

d <- summarySE(Hg, measurevar="THg_DOC", groupvar=c("Position", "Size"))
head(d)

ggplot(d1, aes(x=Position, y=THg_DOC, fill=factor(Size))) + 
  geom_bar(stat="identity", position=position_dodge())
theme(axis.text.y = element_text(size= 20, colour="black"),
      axis.title.x = element_text(size = 20, margin=margin(20,0,0,0)),
      axis.title.y = element_text(size = 24, margin=margin(0,20,0,0)),
      strip.text.x = element_text(size = 26),
      axis.text.x = element_text(angle=0, vjust=1, size = 24, colour="black"),
      plot.title=element_text(size=30))+
  labs(title = "MeHg/DOC", x = "", y = "MeHg:DOC (ng/mg)")+
  geom_errorbar(aes(ymin=MeHg_DOC-sd, ymax=MeHg_DOC+sd), position=position_dodge(0.9),
                width=.2, col="black")
```

#2) VELDIG BRA BAR FOR TID PÅ X-AKSE 

```{r}
#for the facet, the side of the variable you put the .~ determined if vertical or horisontal
dx$Date = as.Date(dx$Date)
HMW<- subset(d1, Size == "HMW")
LMW<- subset(d1, Size == "LMW")
#|Position == "Hypolimnion"
#See all data next to each other either with natural or compressed x-axis
ggplot(data = subset(d1, Position == "Inlet"|Position == "Outlet"),
       aes(y=DOC, x=Date, fill=(factor(Position))))+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  geom_bar(position=position_dodge(), stat="identity", size=1, linetype="dashed")+
  facet_grid(Size~., scale="free")
ggtitle("sUVa")

```


# 3) For å se om forskjeller i gjennomsnitt mellom inlet, hypo og outlet. Lager et sammendrag først og så plottes det

```{r}
library(Rmisc)
head(dx)
dx =na.omit(dx)
ds <- summarySE(dx, measurevar="sUVa", groupvar=c("Size", "Position"))
head(ds)
length(dx$Position)

head(ds)
# Convert dose to a factor variable
df2$dose=as.factor(df2$dose)

ggplot(ds, aes(x=factor(Position), y=Labile)) + 
  geom_bar(stat="identity", position=position_dodge())+
  geom_errorbar(aes(ymin=Labile-sd, ymax=Labile+sd), width=0.2, position=position_dodge(.9))+
  facet_grid(. ~ factor(Size))

```

#4) #4) Correlation plots 
#Correlation plots, LMW/HMW, and INlet/Outlet
```{r}
d <- subset(d, Lake == "Inlet"| Lake =="Outlet")
d <- subset(d, Fraction == "LMW"| Fraction =="HMW")
head(dx)
#IMPORTANT!!! Correlation plot for biodeg and parameters
ggplot(dx, aes(DOC_natural, DOC_TFF))+
  geom_point(aes(colour=interaction(factor(Size))), size=6)+
  geom_smooth(method = "lm", se = FALSE, colour="black")+
  facet_grid(. ~ factor(Position))+
  theme(axis.text.y = element_text(size= 22),
        axis.title.x = element_text(size = 24, margin=margin(20,0,0,0)),
        axis.title.y = element_text(size = 24, margin=margin(0,20,0,0)),
        strip.text.x = element_text(size = 32),
        axis.text.x = element_text(angle=0, hjust=0.5, vjust=0, size = 24),
        plot.title=element_text(size=30, face="bold"),
        legend.text=element_text(size=26),
        legend.title = element_blank())
labs(title = "DOM Size and Aromaticity", x = "sUVa (Abs254:DOC*100)", y = "Rate of DOC decay:DOC (/h)")
ylim(0, -0.007)+
  scale_colour_manual(values=c("#F8766D", "#7CAE00", "#00BFC4"))+
  xlim(0, 8)
```

## Biodegradation data
```{r}
b1 <- read.table("Copy of Climer_Biodeg_3.txt", sep = "\t", header = TRUE, fill=TRUE)

b2 <- subset(b1, Lake!="Hypolimnion")
b3<-subset(b2,Fraction!="Bulk")

#Rate.DOC.ave
ggplot(b2, aes(x=Fraction, y= Rate.DOC.ave, fill=Fraction))+
  geom_boxplot()+
  facet_grid(.~Lake)+
  scale_y_reverse() 

ggplot(LM, aes(x=Fraction, y= Rate.DOC.ave, fill=Fraction))+
  geom_boxplot()+
  facet_grid(.~Lake)+
  scale_y_reverse() 
 

ggplot(b3, aes(x=Fraction, y= Rel.rate.DOC))+
  geom_boxplot()+
  facet_grid(.~Lake)

ggplot(b3, aes(x=Lake, y= Rate.DOC.ave, fill=Lake))+
  geom_boxplot()+
  facet_grid(.~Fraction)+
  scale_y_reverse() 

ggplot(b2, aes(x=Lake, y= Rate.DOC.ave, fill=Lake))+
  geom_boxplot()+
  facet_grid(.~Fraction)

```

## Test for normality and significant difference
```{r}
LMWb <- subset(b3, Fraction == "LMW")
HMWb <- subset(b3, Fraction == "HMW")

#Visual inspection: density plot and QQ plot
ggdensity(LMWb$Rate.DOC.ave, 
          main = "Density plot of tooth length",
          xlab = "Tooth length")

ggdensity(HMWb$Rate.DOC.ave, 
          main = "Density plot of tooth length",
          xlab = "Tooth length")

ggqqplot(LMW$Rate.DOC.ave)
ggqqplot(HMW$Rate.DOC.ave)

#Normality test
shapiro.test(LMWb$Rate.DOC.ave)
shapiro.test(HMWb$Rate.DOC.ave)
length(LMWb$Rate.DOC.ave)
length(HMWb$Rate.DOC.ave)
```

```{r Pairwise comparison}
#"two.sided" (default),
wilcox.test(Rate.DOC.ave ~ Fraction, data=b3) 
wilcox.test(Rate_C_mg_ave ~ Fraction, data=b3) 
wilcox.test(Rel.rate.DOC ~ Lake, data=LMWb) 
#remove outlier
wilcox.test(Rel.rate.DOC ~ Lake, data=LMWb_G) 
wilcox.test(Rel.rate.DOC ~ Lake, data=HMWb) 

LMWb_G <- subset(LMWb, Rel.rate.DOC > 25)

HMW <- subset(dx, Size =="HMW")

#Visualise boxplot
library("ggpubr")

ggboxplot(HMWb, x = "Lake", y = "Rel.rate.DOC", 
          color = "Lake", palette = c("#00AFBB", "#E7B800"),
          ylab = "Weight", xlab = "Groups")

wilcox.test(E2_E3 ~ Position, data=HMW)

```
## Correlation plots with biodeg data

```{r}
ggplot(b3, aes( E2_E3, Rate.DOC.ave))+
  geom_point(size=6, aes(shape=Fraction, colour=Fraction))+
  geom_smooth(method = "lm", se = FALSE, colour="black")+
  stat_regline_equation(label.x=0.35, label.y=-0.007) +
  stat_cor(aes(label=..rr.label..), label.x=0.35, label.y=-0.008)+
  theme(axis.text.y = element_text(size= 22),
        axis.title.x = element_text(size = 24, margin=margin(20,0,0,0)),
        axis.title.y = element_text(size = 24, margin=margin(0,20,0,0)),
        strip.text.x = element_text(size = 32),
        axis.text.x = element_text(angle=0, hjust=0.5, vjust=0, size = 24),
        plot.title=element_text(size=30, face="bold"),
        legend.text=element_text(size=26),
        legend.title = element_blank())+
  stat_cor(method = "pearson", label.x = 0.30, label.y = -0.009)+
    facet_grid(.~Lake)
```

#Correlation plots, LMW/HMW, and INlet/Outlet

```{r}
# GET EQUATION AND R-SQUARED AS STRING
# SOURCE: https://groups.google.com/forum/#!topic/ggplot2/1TgH-kG5XMA

lm_eqn <- function(df){
    m <- lm(y ~ x, df);
    eq <- substitute(italic(y) == a + b %.% italic(x)*","~~italic(r)^2~"="~r2, 
         list(a = format(unname(coef(m)[1]), digits = 2),
              b = format(unname(coef(m)[2]), digits = 2),
             r2 = format(summary(m)$r.squared, digits = 3)))
    as.character(as.expression(eq));
}

#p1 <- p + geom_text(x = 25, y = 300, label = lm_eqn(df), parse = TRUE)
```

For statistically comparing groups: http://www.sthda.com/english/articles/24-ggpubr-publication-ready-plots/76-add-p-values-and-significance-levels-to-ggplots/

```{r Correlation biodeg data}
library(ggpubr)

stat_compare_means(ref.group = "0.5", label = "p.signif",
                     label.y = c(22, 29)) 


LM <- subset(b3, Fraction=="LMW")
HM <- subset(b3, Fraction=="HMW")

Inl <- subset(b3, Lake=="Inlet")
Outl <- subset(b3, Lake=="Outlet")

ggplot(dx, aes(sUVa, THg_DOC))+
  geom_point(size=6, aes(shape=Size, colour=Size))+
  geom_smooth(method = "lm", se = FALSE, colour="black")+
  stat_regline_equation(label.x=0.35, label.y=4.5) +
  stat_cor(aes(label=..rr.label..), label.x=0.35, label.y=4)+
  theme(axis.text.y = element_text(size= 22),
        axis.title.x = element_text(size = 24, margin=margin(20,0,0,0)),
        axis.title.y = element_text(size = 24, margin=margin(0,20,0,0)),
        strip.text.x = element_text(size = 32),
        axis.text.x = element_text(angle=0, hjust=0.5, vjust=0, size = 24),
        plot.title=element_text(size=30, face="bold"),
        legend.text=element_text(size=26),
        legend.title = element_blank())+
  stat_cor(method = "pearson", label.x = 0.30, label.y = 5)+
    facet_grid(.~Position)


  
  #  facet_grid(Lake ~ Fraction, scales="free")
labs(title = "DOM Size and Aromaticity", x = "sUVa (Abs254:DOC*100)", y = "Rate of DOC decay:DOC (/h)")
ylim(0, -0.007)+
  scale_colour_manual(values=c("#F8766D", "#7CAE00", "#00BFC4"))+
  xlim(0, 8)
```

# Biodeg correlation plot
```{r}
class(b2$sUVa)
library(dplyr)
b2x <- na.omit(b2$Rate.DOC.ave)

correlation_by_group <- b2x %>%
  group_by(Lake, Fraction) %>%
  summarise(correlation = cor(Rate.DOC.ave, sUVa))

# Print the result
print(correlation_by_group)
```

