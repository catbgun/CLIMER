---
title: "220602_CLIMER_monitoringData"
author: "CBG"
date: "2 6 2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


The following file can not be found. 
```{r}
#setwd("//niva-of5/osl-userdata$/CBG/Documents/R/Projects/CLIMER TFF/CLIMER TFF")
#dx <- read.table("TOC_Hg_Abs_Inlet__Hyp_outlet_2016_2019_2.txt", sep = "\t", header = TRUE)
#found errors in the abs data at 365 nm. May also be errors at other wavelengths, for the inlet. Outlet seems ok and 254 nm ok
#dx <- read.table("TOC_Hg_Abs_Inlet__Hyp_outlet_2016_2019_3.txt", sep = "\t", header = TRUE)

dx <- read.table("TOC_Hg_Abs_Inlet__Hyp_outlet_2016_2019_4.txt", sep = "\t", header = TRUE)
print(unique(dx$Station))

library(plyr)
dx$Station <- revalue(dx$Station, c("Langtjern, utl??p" = "Outlet","Innl??psbekk ??st" = "Inlet"))

```

```{r}
library(ggplot2)
library(magrittr)
library(dplyr)
library(scales)
library(lubridate)
library(anytime) 
```


```{r}
#FIND variability in inlet vs outlet TOC
outlet <- subset(dx,  Station =="Outlet")
inlet <- subset(dx,  Station =="Inlet")
#dx<-dx[!(dx$Station=="Hypolimnion"),]

library(pastecs)
stat.desc(outlet)

dx$Date <- as.Date(dx$Date,format = "%d.%m.%Y")

dx$Year=format(as.Date(dx$Date, format="%d.%m.%Y"),"%Y")
dx$month_day=format(as.Date(dx$Date, format="%d.%m"),"%d.%m")
dx$month_day <- as.Date(dx$month_day,format = "%d.%m")


#dx$year <- tidyr::separate(dx, Date, c('year'), sep = "-",remove = FALSE)
#dx$year <- transform(dx,  year = format(Date, "%Y"))

#date = format(Date, "%d"), month = format(Date, "%m"),

head(dx)
str(dx)

#dx$labile_m = (dx$X285nm/dx$TOC_m)*100
#dx$labile_s = (dx$X285nm_s/dx$DOC_s)*100

dx$sUVa_m = (dx$X254nm/dx$TOC_m)*100
dx$sUVa_s = (dx$X254nm_s/dx$DOC_s)*100

#dx$sVISa_m = (dx$X400nm/dx$TOC_m)*1000
#dx$sVISa_s = (dx$X400nm_s/dx$DOC_s)*1000

#dx$SAR_m = (dx$X254nm/dx$X400nm)*1000
#dx$SAR_s = (dx$X400nm_s/dx$DOC_s)*1000

dx$E2E3_m = (dx$X254nm/dx$X365nm)
dx$E2E3_s = (dx$X254nm_s/dx$X365nm_s)

dx$THGTOC_m2 = dx$THg_m/dx$TOC_m
dx$THGDOC_s2 = dx$THg_s/dx$DOC_s


#dx$MeHg_rel_m = (dx$MeHg_m/dx$THg_m)*100
#summary(dx$MeHg_rel_m)
#head(dx)
```

```{r Plotting monitoring data}
#PLOTTING with time on x-axis and year-facets
class(dx$Date)
class(dx$month_day)

#TOC
ggplot(dx)+
  geom_point(aes(x=month_day, y=THg_m, shape=Station, colour=Year), size=5)+
  #geom_line(aes(x=month_day, y=TOC_m, colour=Station))+
  geom_smooth(aes(x=month_day, y=THg_m, colour=Station), shape=16, size=1)+
  #geom_point(aes(x=month_day, y=DOC_s, colour=Station), shape=17, size=5)+
  scale_x_date(labels = date_format("%b"),breaks = date_breaks("2 months"))+
  theme_bw()+
  labs(y = "TOC (mg/L)")+
   theme(
    legend.text = element_text(size = 14),
    legend.title = element_text(size = 14),
    axis.text.x = element_text(size=12, angle = 45, hjust = 1),
    axis.text.y = element_text(size=12),
    strip.text = element_text(size = 12),
    axis.title.x = element_blank(),
    axis.title.y = element_text(margin = margin(t = 0, r = 15, b = 0, l = 0))
  )+
  facet_grid(.~ Year)
  
ggplot(dx)+
  geom_point(aes(x=month_day, y=TOC_m, colour=Station), shape=16, size=4.5)+
  #geom_line(aes(x=month_day, y=TOC_m, colour=Station))+
  geom_smooth(aes(x=month_day, y=TOC_m, colour=Station), shape=16, size=1.2)+
  geom_point(aes(x=month_day, y=DOC_s, colour=Station), shape=17, size=4.5)+
  scale_x_date(labels = date_format("%b"),breaks = date_breaks("2 months"))+
  theme_bw()+
  labs(y = "DOC (mg/L)")+
   theme(
    legend.text = element_text(size = 16),
    legend.title = element_blank(),
    axis.text.x = element_text(size=16, angle = 45, hjust = 1, colour="black"),
    axis.text.y = element_text(size=17, colour="black"),
    strip.text = element_text(size = 17),
    axis.title.x = element_blank(),
    axis.title.y = element_text(margin = margin(t = 0, r = 15, b = 0, l = 0), size=17, colour="black")
  )+
  facet_grid(.~ Year)
  scale_colour_manual(values = c("#0072B2", "#CC79A7"))
  
ggsave(filename = "output/TOC_m.png",
       plot = TOC,
       width = 11, height = 7, units = "in")


#THg:TOC
class(dx$THg_m)
jj <- subset(dx, Station== "Outlet")

ggplot(dx)+
  geom_point(aes(x=month_day, y=as.numeric(THGTOC_m2), colour=Station), shape=16, size=4.5)+
  geom_smooth(aes(x=month_day, y=as.numeric(THGTOC_m2), colour=Station), shape=16, size=1.2)+
  geom_point(aes(x=month_day, y=as.numeric(THGDOC_s2), colour=Station), shape=17, size=4.5)+
  scale_x_date(labels = date_format("%b"),breaks = date_breaks("2 months"))+
  theme_bw()+
  labs(y = "Hg:DOC (ng/mg)")+
   theme(
    legend.text = element_text(size = 16),
    legend.title = element_blank(),
    axis.text.x = element_text(size=16, angle = 45, hjust = 1, colour="black"),
    axis.text.y = element_text(size=17, colour="black"),
    strip.text = element_text(size = 17),
    axis.title.x = element_blank(),
    axis.title.y = element_text(margin = margin(t = 0, r = 15, b = 0, l = 0), size=17, colour="black")
  )+
  facet_grid(.~ Year)+
  scale_colour_manual(values = c("#0072B2", "#CC79A7"))


ggsave(filename = "output/Hg_DOC_m.png",
       plot = Hg_DOC,
       width = 11, height = 7, units = "in")

#THg
class(dx$THg_m)
jj <- subset(dx, Station== "Outlet")

ggplot(dx)+
  geom_point(aes(x=month_day, y=as.numeric(TOC_m), colour=Station), shape=16, size=4.5)+
  geom_smooth(aes(x=month_day, y=as.numeric(TOC_m), colour=Station), shape=16, size=1.2)+
  #geom_point(aes(x=month_day, y=as.numeric(THg_s), colour=Station), shape=17, size=4.5)+
  scale_x_date(labels = date_format("%b"),breaks = date_breaks("2 months"))+
  theme_bw()+
  labs(y = "Hg (ng/L)")+
   theme(
    legend.text = element_text(size = 16),
    legend.title = element_blank(),
    axis.text.x = element_text(size=16, angle = 45, hjust = 1, colour="black"),
    axis.text.y = element_text(size=17, colour="black"),
    strip.text = element_text(size = 17),
    axis.title.x = element_blank(),
    axis.title.y = element_text(margin = margin(t = 0, r = 15, b = 0, l = 0), size=17, colour="black")
  )+
  #facet_grid(.~ Year)+
  scale_colour_manual(values = c("#0072B2", "#CC79A7"))


ggsave(filename = "output/Hg_DOC_m.png",
       plot = Hg_DOC,
       width = 11, height = 7, units = "in")


#sUVa
ggplot(dx)+
  geom_point(aes(x=month_day, y=sUVa_m, colour=Station), shape=16, size=4.5)+
  geom_smooth(aes(x=month_day, y=sUVa_m, colour=Station), shape=16, size=1.2)+
  #geom_point(aes(x=month_day, y=sUVa_s, colour=Station), shape=17, size=4.5)+
  scale_x_date(labels = date_format("%b"),breaks = date_breaks("2 months"))+
    theme_bw()+
  labs(y = "sUVa-254nm (L/mg C m)")+
  theme(
    legend.text = element_text(size = 16),
    legend.title = element_blank(),
    axis.text.x = element_text(size=16, angle = 45, hjust = 1, colour="black"),
    axis.text.y = element_text(size=17, colour="black"),
    strip.text = element_text(size = 17),
    axis.title.x = element_blank(),
    axis.title.y = element_text(margin = margin(t = 0, r = 15, b = 0, l = 0), size=17, colour="black")
  )+
  facet_grid(.~ Year)+
  scale_colour_manual(values = c("#0072B2", "#CC79A7"))

ggsave(filename = "output/sUVa_m.png",
       plot = sUVa,
       width = 11, height = 7, units = "in")

#LOOk at difference between inlet and outlet in suva

dx$Dates = dx$Date
inl <- subset(dx, Station =="Inlet")
out <- subset(dx, Station =="Outlet")

both <- merge(inl, out, by="Dates")
both$diff <- (both$sUVa_m.x - both$sUVa_m.y)
both$diff2 <- (both$E2E3_m.x - both$E2E3_m.y)
both$diff3 <- (both$THGTOC_m2.x - both$THGTOC_m2.y)
both$diff4 <- (both$THg_m.x - both$THg_m.y)
both$THg_m.y
typeof(both$sUVa_m.x)

bothy <- subset(both, !Year.x == 2016)

ggplot(bothy)+
  #geom_point(aes(x=month_day.x, y=diff, colour=Year.x), shape=16, size=2)+
  geom_point(aes(x=month_day.x, y=diff3, colour=Year.x), size=2)+
  geom_smooth(aes(x=month_day.x, y=diff3), size=1.2)+
  #geom_point(aes(x=month_day, y=sUVa_s, colour=Station), shape=17, size=4.5)+
  scale_x_date(labels = date_format("%b"),breaks = date_breaks("2 months"))+
    theme_bw()+
  labs(y = "Inlet - Outlet (THg)")+
  theme(
    legend.text = element_text(size = 16),
    legend.title = element_blank(),
    axis.text.x = element_text(size=16, angle = 45, hjust = 1, colour="black"),
    axis.text.y = element_text(size=17, colour="black"),
    strip.text = element_text(size = 17),
    axis.title.x = element_blank(),
    axis.title.y = element_text(margin = margin(t = 0, r = 15, b = 0, l = 0), size=17, colour="black")
  )+
  geom_hline(yintercept = 0)
  

facet_grid(.~ Year.x)
  
scale_colour_manual(values = c("#0072B2", "#CC79A7"))

ggsave(filename = "output/sUVa_m.png",
       plot = sUVa,
       width = 11, height = 7, units = "in")



class(dx$E2_E3_m)

ggplot(dx)+
  geom_point(aes(x=month_day, y=E2E3_m, colour=Station), shape=16, size=4.5)+
  geom_smooth(aes(x=month_day, y=E2E3_m, colour=Station), shape=16, size=1.2)+
  geom_point(aes(x=month_day, y=E2E3_s, colour=Station), shape=17, size=4.5)+
  scale_x_date(labels = date_format("%b"),breaks = date_breaks("2 months"))+
    theme_bw()+
  labs(y = "E2:E3")+
  theme(
    legend.text = element_text(size = 16),
    legend.title = element_blank(),
    axis.text.x = element_text(size=16, angle = 45, hjust = 1, colour="black"),
    axis.text.y = element_text(size=17, colour="black"),
    strip.text = element_text(size = 17),
    axis.title.x = element_blank(),
    axis.title.y = element_text(margin = margin(t = 0, r = 15, b = 0, l = 0), size=17, colour="black")
  )+
  facet_grid(.~ Year)+
  scale_colour_manual(values = c("#0072B2", "#CC79A7"))

ggsave(filename = "output/E2_E3.png",
       plot = E2_E3,
       width = 11, height = 7, units = "in")


#Hg
ggplot(dx)+
  geom_point(aes(x=month_day, y=THg_m, colour=Station), shape=16, size=5)+
  geom_smooth(aes(x=month_day, y=THg_m, colour=Station), shape=16, size=2)+
  geom_point(aes(x=month_day, y=THg_s, colour=Station), shape=17, size=5)+
  scale_x_date(labels = date_format("%b"),breaks = date_breaks("2 months"))+
  theme_bw()+
     labs(y = "THg (ng/L)")+
   theme(
    legend.text = element_text(size = 14),
    legend.title = element_text(size = 14),
    axis.text.x = element_text(size=12, angle = 45, hjust = 1),
    axis.text.y = element_text(size=12),
    strip.text = element_text(size = 12),
    axis.title.x = element_blank(),
    axis.title.y = element_text(margin = margin(t = 0, r = 15, b = 0, l = 0))
  )+
  facet_grid(.~ Year)  


#size
ggplot(dx)+
  geom_point(aes(x=Date, y=TOC_m, colour=Station), shape=16, size=5)+
  geom_smooth(aes(x=Date, y=TOC_m, colour=Station), shape=16, size=2)+
  #geom_point(aes(x=month_day, y=THg_s, colour=Station), shape=17, size=5)+
  scale_x_date(labels = date_format("%b"),breaks = date_breaks("2 months"))+
  theme_bw()+
     labs(y = "THg")+
   theme(
    legend.text = element_text(size = 14),
    legend.title = element_text(size = 14),
    axis.text.x = element_text(size=12, angle = 45, hjust = 1),
    axis.text.y = element_text(size=12),
    strip.text = element_text(size = 12),
    axis.title.x = element_blank(),
    axis.title.y = element_text(margin = margin(t = 0, r = 15, b = 0, l = 0))
  )
  facet_grid(.~ Year)  

ggplot(dx)+
  geom_point(aes(x=month_day, y=THg_m, colour=Station), shape=16, size=5)+
  geom_smooth(aes(x=month_day, y=THg_m, colour=Station), shape=16, size=2)+
  #geom_point(aes(x=month_day, y=THg_s, colour=Station), shape=17, size=5)+
  scale_x_date(labels = date_format("%b"),breaks = date_breaks("2 months"))+
  theme_bw()+
     labs(y = "THg")+
   theme(
    legend.text = element_text(size = 14),
    legend.title = element_text(size = 14),
    axis.text.x = element_text(size=12, angle = 45, hjust = 1),
    axis.text.y = element_text(size=12),
    strip.text = element_text(size = 12),
    axis.title.x = element_blank(),
    axis.title.y = element_text(margin = margin(t = 0, r = 15, b = 0, l = 0))
  )+
  facet_grid(.~ Year)  

ggplot(dx)+
  geom_point(aes(x=month_day, y=SAR_m, colour=Station), shape=16, size=5)+
  geom_smooth(aes(x=month_day, y=SAR_m, colour=Station), shape=16, size=2)+
  #geom_point(aes(x=month_day, y=THg_s, colour=Station), shape=17, size=5)+
  scale_x_date(labels = date_format("%b"),breaks = date_breaks("2 months"))+
  theme_bw()+
  labs(y = "SAR")+
   theme(
    legend.text = element_text(size = 14),
    legend.title = element_text(size = 14),
    axis.text.x = element_text(size=12, angle = 45, hjust = 1),
    axis.text.y = element_text(size=12),
    strip.text = element_text(size = 12),
    axis.title.x = element_blank(),
    axis.title.y = element_text(margin = margin(t = 0, r = 15, b = 0, l = 0))
  )+
  facet_grid(.~ Year) +
  ylim(7000, 9000)

, scales="free_x")
  ylim(4, 7)
      
  facet_grid(.~year, scales="free_x")
scale_x_date(labels = date_format("%b"),breaks = date_breaks("2 months"))+
 
  ggplot(dx)+
  geom_point(aes(x=Date, y=TOC_m, colour=Station), shape=16, size=5)+
  geom_smooth(aes(x=Date, y=TOC_m, colour=Station), shape=16, size=2)+
      scale_x_date(labels = date_format("%b"),breaks = date_breaks("2 months"))+
  facet_grid(.~year(dx$Date), scales="free_x")+
  theme_bw()
  ylim(4, 7)

scale_y_continuous(limit=c(3.2, 4))
geom_point(aes(x=Date, y=labile_s, colour=Station), shape=17, size=5)+
head(dx)
```

something trange with THg, needs to investigae
```{r}
write.csv(dx, "climer checkin.csv")
```

21.06.2024 - test for significant difference between inlet and outlet in 
TOC, sUVa, THg, THg and THg-TOC
- first check if data is normally distrubuted (Shapiro-wilk test)
From the output, the p-value > 0.05 implying that the distribution of the data are not significantly different from normal distribution. In other words, we can assume the normality.
- then perform corrct test (t-test or Mann Whitney )

If the sample size is large enough (n > 30), we can ignore the distribution of the data and use parametric tests.
```{r normal ditribution and difference inlet/outlet}
library(dplyr)
library(ggpubr)

inlet_TOC <- subset(dx, Station == "Inlet")
outlet_TOC <- subset(dx, Station == "Outlet")
length(inlet_TOC$TOC)
length(outlet_TOC$TOC)

#Visual inspection: density plot and QQ plot
ggdensity(inlet_TOC$TOC, 
          main = "Density plot of tooth length",
          xlab = "Tooth length")

ggdensity(outlet_TOC$TOC, 
          main = "Density plot of tooth length",
          xlab = "Tooth length")

ggqqplot(inlet_TOC$TOC)
ggqqplot(outlet_TOC$TOC)

#Normality test
shapiro.test(inlet_TOC$TOC)
shapiro.test(outlet_TOC$TOC)

```

```{r sUVa normality test}
inlet_sUVa_m <- subset(dx, Station == "Inlet")
outlet_sUVa_m <- subset(dx, Station == "Outlet")
length(inlet_sUVa_m$sUVa_m)
length(outlet_sUVa_m$sUVa_m)

#Visual inspection: density plot and QQ plot
ggdensity(inlet_sUVa_m$sUVa_m, 
          main = "Density plot of tooth length",
          xlab = "Tooth length")

ggdensity(outlet_sUVa_m$sUVa_m, 
          main = "Density plot of tooth length",
          xlab = "Tooth length")

ggqqplot(inlet_sUVa_m$sUVa_m)
ggqqplot(outlet_sUVa_m$sUVa_m)

#Normality test
shapiro.test(inlet_sUVa_m$sUVa_m)
shapiro.test(outlet_sUVa_m$sUVa_m)
```

```{r E2_E3 normality test}
inlet_E2_E3_m <- subset(dx, Station == "Inlet")
outlet_E2_E3_m <- subset(dx, Station == "Outlet")
length(inlet_E2_E3_m$E2_E3_m)
length(outlet_E2_E3_m$E2_E3_m)

#Visual inspection: density plot and QQ plot
ggdensity(inlet_E2_E3_m$E2_E3_m, 
          main = "Density plot of tooth length",
          xlab = "Tooth length")

ggdensity(outlet_E2_E3_m$E2_E3_m, 
          main = "Density plot of tooth length",
          xlab = "Tooth length")

ggqqplot(inlet_E2_E3_m$E2_E3_m)
ggqqplot(outlet_E2_E3_m$E2_E3_m)

#Normality test
shapiro.test(inlet_E2_E3_m$E2_E3_m)
shapiro.test(outlet_E2_E3_m$E2_E3_m)
```

```{r THg normality test}
inlet_THg_m <- subset(dx, Station == "Inlet")
outlet_THg_m <- subset(dx, Station == "Outlet")
length(inlet_THg_m$THg_m)
length(outlet_THg_m$THg_m)

#Visual inspection: density plot and QQ plot
ggdensity(inlet_THg_m$THg_m, 
          main = "Density plot of tooth length",
          xlab = "Tooth length")

ggdensity(outlet_THg_m$THg_m, 
          main = "Density plot of tooth length",
          xlab = "Tooth length")

ggqqplot(inlet_THg_m$THg_m)
ggqqplot(outlet_THg_m$THg_m)

#Normality test
shapiro.test(inlet_THg_m$THg_m)
shapiro.test(outlet_THg_m$THg_m)
```

```{r THgTOC_TOC normality testing}
inlet_THGTOC_m <- subset(dx, Station == "Inlet")
outlet_THGTOC_m <- subset(dx, Station == "Outlet")
length(inlet_THGTOC_m$THGTOC_m)
length(outlet_THGTOC_m$THGTOC_m)

#Visual inspection: density plot and QQ plot
ggdensity(inlet_THGTOC_m$THGTOC_m, 
          main = "Density plot of tooth length",
          xlab = "Tooth length")

ggdensity(outlet_THGTOC_m$THGTOC_m, 
          main = "Density plot of tooth length",
          xlab = "Tooth length")

ggqqplot(inlet_THGTOC_m$THGTOC_m)
ggqqplot(outlet_THGTOC_m$THGTOC_m)

#Normality test
shapiro.test(inlet_THGTOC_m$THGTOC_m)
shapiro.test(outlet_THGTOC_m$THGTOC_m)
```


```{r}
library(rstatix)
# Pairwise comparisons

library("ggpubr")
class(HMW$sUVa)
ggboxplot(dx, x = "Station", y = "THGTOC_m", 
          color = "Station", palette = c("#00AFBB", "#E7B800"),
          ylab = "Weight", xlab = "Groups")


y16 <- subset(dx, Year== "2016")

pwc1 <- dx %>%
  pairwise_t_test(TOC_m ~ Station, paired=FALSE, alternative= "two.sided")
pwc2 <- dx %>%
  pairwise_t_test(sUVa_m ~ Station, paired=FALSE, alternative= "two.sided")
pwc3 <- dx %>%
  pairwise_t_test(E2_E3_m ~ Station, paired=FALSE, alternative= "two.sided")
pwc4 <- dx %>%
  pairwise_t_test(THg_m ~ Station, paired=FALSE, alternative= "two.sided")
pwc5 <- dx %>%
  pairwise_t_test(THGTOC_m ~ Station, paired=FALSE, alternative= "two.sided")

pwc1
pwc2
pwc3
pwc4
pwc5


pwc6 <- y16 %>%
  pairwise_t_test(sUVa_m ~ Station, paired=FALSE, alternative= "two.sided")
pwc7 <- y16 %>%
  pairwise_t_test(E2_E3_m ~ Station, paired=FALSE, alternative= "two.sided")
pwc6
pwc7

```


Correlation plots
```{r}
library("ggpubr")
head(dx)

#dy<-dx[!(dx$Year=="2016"),]

inelt <- subset(dx, Station =="Inlet")


dx <- dx %>%
  mutate(
    year = year(Date),   # Extracts the year
    month = month(Date), # Extracts the month as a number
    day = day(Date)      # Extracts the day of the month
  )

print(unique(dx2$month))

dx2 <- dx %>%
  mutate(
    season = case_when(
      month == 12 ~ "Winter",
      month == 1 ~ "Winter",
      month == 2 ~ "Winter",
      month == 3 ~ "Spring",
      month == 4 ~ "Spring",
      month == 5 ~ "Spring",
      month == 6 ~ "Summer",
      month == 7 ~ "Summer",
      month == 8 ~ "Summer",
      month == 9 ~ "Autumn",
      month == 10 ~ "Autumn",
      month == 11 ~ "Autumn"
      # This line catches all remaining values
    )
  )


#colour-code by month
ggplot(dx2)+
  geom_point(aes(x =log(TOC_m), y = log(THg_m), colour=as.factor(month)))
  facet_grid(.~month)


ggscatter(dx, x = "TOC_m", y = "THg_m", #why no correlation to suva? greater seasonality in suva than TOC?
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab ="TOC" , ylab ="THg (ng/L)")+
          facet_grid(.~Station)

ggscatter(dx, x ="TOC_m",  y ="THg_m",  
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab ="sUVa" , ylab ="THg (ng/L)")+
  facet_grid(.~Station)


ggscatter(dx, x ="sUVa_m",  y ="THGTOC_m",  
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab ="" , ylab ="")+
  facet_grid(.~Station)

ggscatter(dx, x ="E2_E3_m",  y ="THGTOC_m",  
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab ="" , ylab ="")+
  facet_grid(.~Station)


    facet_grid(.~year(dx$Date), scales="free_x")
    

#CONTINUING previous plots
    
head(dx)
class(dx$TOC_m)
    #IMPORTANT!!! Correlation plot for Hg and DOM 
  ggplot(dx, aes(TOC_m, THg_m))+
      geom_point(size=6)+
      geom_smooth(method = "lm", se = FALSE, colour="black")
      facet_grid(. ~ factor(Station), scales="free")
      xlim(4, 6)
      
      inlet <- subset(dx, Station == "Inlet")
      outlet <- subset(dx, Station == "Outlet")
    head(dx)
      #Correlation analysis
      library(dplyr)
      b <- select(dx, TOC_m, THg_m, MeHg_m, sUVa_m, sVISa_m, SAR_m, THg_m, labile_m, THGTOC_m, MeHGTOC_m)
      library(Hmisc)
      rcorr(as.matrix(b), type="pearson")
      class(d)
      library("PerformanceAnalytics")
      chart.Correlation(b, histogram=TRUE, pch=19)
      head(d)
      
      
      #MAKKING THE CORRELATION ASSESSMENT
      library(tidyverse)
      library(ggpubr)
      theme_set(theme_pubr())
      ggplot(outlet, aes(x = SAR_m, y = THGTOC_m)) +
        geom_point() +
        stat_smooth()+
        stat_smooth(method = lm)
      
model <- lm(THGTOC_m ~ sVISa_m, data = dx)
model  
summary(model)
```

Timeline, seasonality and correlations
- first, regularize the data (do we need to different since less Hg data?)
- seasonal decomposition
- correlation analysis

- keep in mind possible lag in time
- Hg shorter time frame than TOC
```{r}
dx_ts <- dx[,c(3:6)]
#dx_ts$Date <- format(dx$Date, format = "%Y.%m.%d")

dx_ts_inlet <- subset(dx_ts, Station == "Inlet") #daily?
dx_ts_outlet <- subset(dx_ts, Station == "Outlet") #daily?

# 1. Create a new data.frame that has a full sequence of dates, one for inlet and one for outlet
full_out <- data.frame(
  Date = seq(min(dx_ts_outlet$Date), max(dx_ts_outlet$Date), by = "day"))

full_in <- data.frame(
  Date = seq(min(dx_ts_inlet$Date), max(dx_ts_inlet$Date), by = "day"))


# 2. Merge with the old one on the `date` column
new_ts_out <- merge(full_out, dx_ts_outlet, by = "Date", all.x = TRUE)
new_ts_in <- merge(full_in, dx_ts_inlet, by = "Date", all.x = TRUE)

# 3. Some values are now missing - replace them with 0
#new_ts$TOC_m[is.na(new_ts$TOC_m)] <- 0
#29.des 2021 ia the final date with Hg
#row 2189 final, 2165 inlet
library(zoo)
new_ts_out$inter_TOC_out <- na.approx(new_ts_out$TOC_m)
new_ts_in$inter_TOC_in <- na.approx(new_ts_in$TOC_m)

new_ts_out1 <- new_ts_out[c(30:2189),] #compemnsate for shorter timeframe. AVoid leading or ending NAs
new_ts_in1 <- new_ts_in[c(1:2165),]

new_ts_out1$inter_THg_out <- na.approx(new_ts_out1$THg_m, na.rm = TRUE)
new_ts_in1$inter_THg_in <- na.approx(new_ts_in1$THg_m)

#simple plots
qplot(x=Date, y=TOC_m,data=new_ts)
  facet_grid(Station~.)
qplot(x=Date, y=THg_m, data=dx_ts)+
  facet_grid(Station~.)

#try decompose
#https://www.statology.org/how-to-perform-time-series-decomposition-r/
#ts3_out <- new_ts_out[,c(1, 5)]
#ts3_inl <- new_ts_inl[,c(1, 5)]
#frequency(ts3)
#class(ts3)

A1_out <- ts(new_ts_out, frequency=365)
A1_inl <- ts(new_ts_inl, frequency=365)

B1_out <- ts(new_ts_out1, frequency=365)
B1_inl <- ts(new_ts_in1, frequency=365)


# Perform additive decomposition
decomposed_TOC_out <- decompose(A1_out[,5], type = "additive")
decomposed_TOC_in <- decompose(A1_inl[,5], type = "additive")

decomposed_Hg_out <- decompose(B1_out[,6], type = "additive")
decomposed_Hg_in <- decompose(B1_inl[,6], type = "additive")


#stl_decomposed_data <- stl(A1[,2], s.window = "periodic")
#plot(stl_decomposed_data)
plot(decomposed_data_inl)
title("Langtjern TOC inlet")

plot(decomposed_Hg_out)
title("Langtjern Hg inlet")

plot(decomposed_data$trend, decomposed_data_inl$trend)  

# Plot the decomposition
plot(decomposed_data)

#extract to assess correlation
TOC_o_s1 <- decomposed_TOC_out$seasonal;  TOC_o_t1 <- decomposed_TOC_out$trend;  TOC_o_r1 <- decomposed_TOC_out$random
TOC_i_s2 <- decomposed_TOC_in$seasonal;  TOC_o_t2 <- decomposed_TOC_in$trend;  TOC_o_r2 <- decomposed_TOC_in$random

Hg_o_s1 <- decomposed_Hg_out$seasonal;  Hg_o_t1 <- decomposed_Hg_out$trend;  Hg_o_r1 <- decomposed_Hg_out$random
Hg_i_s2 <- decomposed_Hg_in$seasonal;  Hg_i_t2 <- decomposed_Hg_in$trend;  Hg_i_r2 <- decomposed_Hg_in$random

#Compensate for shorter Hg
n <- min(length(Hg_o_s1), length(TOC_o_s1))
ts1_cut <- Hg_o_s1[1:n]
ts2_cut <- TOC_o_s1[1:n]

cor(ts1_cut, ts2_cut, use = "complete.obs")
plot(ts1_cut, ts2_cut)

df_TOC_out <- as.data.frame(decomposed_TOC_out[c("x", "seasonal", "trend", "random")])
df_TOC_in <- as.data.frame(decomposed_TOC_in[c("x", "seasonal", "trend", "random")])
df_THg_out <- as.data.frame(decomposed_Hg_out[c("x", "seasonal", "trend", "random")])
df_THg_in <- as.data.frame(decomposed_Hg_in[c("x", "seasonal", "trend", "random")])

ggplot(df_TOC_out)



library(dplyr)
TOC_o_s1x <- as.numeric(TOC_o_s1)
Hg_o_s1x <- as.numeric(Hg_o_s1)
joined_data <- inner_join(TOC_o_s1x, Hg_o_s1x, by = "Date")

print(joined_data)

cor.test(as.numeric(ts1_shortened), as.numeric(ts2_shortened), method = "pearson")
plot(as.numeric(TOC_o_s1), as.numeric(Hg_o_s1))


#contniue here!!! get date back to data and look at correlation

#correlate trends
#https://www.datascienceinstitute.net/ai-data-science-blog/time-series-decomposition-in-r





#simple plots
qplot(x=Date, y=TOC_m, data=dx_ts)+
  facet_grid(Station~.)
qplot(x=Date, y=THg_m, data=dx_ts)+
  facet_grid(Station~.)

#convert to ts time series format which is basic R
library(stats) 
# Unleash the time series magic!
ts_sales <- ts(dx_ts$TOC_m, frequency = 365)  # Daily data

# Admire your creation:
print(ts_sales)


plot(TOC_m_df, type="l")
plot(dx$TOC, type="l")


#TIMELINE VISUALISATION: https://www.r-bloggers.com/2023/11/time-series-analysis-in-r-how-to-read-and-understand-time-series-data/
typeof(dx$THg_m)
#TOC )2016 - 2026
ggplot(dx, aes(x = Date, y = TOC_m)) +
  geom_line()+
  facet_grid(Station~.)

#Hg (2016-2022)
ggplot(filter(dx, !is.na(THg_m)), aes(x = Date, y = THg_m)) +
  geom_line()+
  facet_grid(Station~.)

library(zoo)


# Create a numeric feature
dx$month_num <- as.numeric(dx$month)

# Fit a linear regression model
model <- lm(TOC_m ~ Month_num, data = dx)
# Get predictions
data$Trend_Line <- predict(model, newdata = data)

head(data[c("Month", "Passengers", "Trend_Line")], 12)
    
#https://a-little-book-of-r-for-time-series.readthedocs.io/en/latest/src/timeseries.#html

plot.ts(dx$TOC_m)

#We can see from the time plot that this time series could probably be described #using an additive model, since the random fluctuations in the data are roughly #constant in size over time.
TOC_m_df <- dx[,c(4:5)]
plot.ts(TOC_m_df)

TOC_m_df2 <- na.omit(TOC_m_df)

TOC_m_ts <- ts(TOC_m_df, frequency=12)
TOC_m_df
birthstimeseriescomponents <- decompose(TOC_m_ts)

```



## Sumamry table

```{r create summary table}
library(dplyr)
library(rbind)

dxy <- do.call(rbind.data.frame, dx)

#dx_sum <- dx[c("Station", "TOC_m", "THg_m", "sUVa_m", "THg_m")]
dx_sum <- select(dx, "Station", "TOC_m", "THg_m", "sUVa_m", "THg_m", "THGTOC_m")

typeof(dx_sum)
class(dx_sum$TOC_m)


inl <- subset(dx_sum, Station  == "Inlet")
ou <- subset(dx_sum, Station  == "Outlet")
length(inl$THgTOC_m, na.omit=TRUE)

colSums(!is.na(ou))

nrow(inl)



inl %>% count(THg_m)

sum <- dx_sum %>% 
  group_by(Station) %>% 
  summarise(across(.cols  = where(is.numeric), .f = list(mean = mean, min = min, max = max, sd = sd), na.rm = TRUE))
  
sum_n <- dx_sum %>% 
  group_by(Station) %>% 
  length(across(.cols  = where(is.numeric)))

write.csv(sum, "summary monitoing.csv")

```

  
#geom_point(aes(x=Date, y=sUVa_s, colour=Station), size=5, shape=17)+
geom_smooth(aes(x=Date, y=sUVa_s, colour=Station), size=2)
#Correlation plots
library("ggpubr")
head(dx)
ggscatter(dx, x = "sUVa_m", y = "sVISa_m", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab ="Molecular SIze (sUVa)" , ylab ="THg:DOC (ng/mg)")
  facet_grid(.~Station)
    facet_grid(.~year(dx$Date), scales="free_x")
    
head(dx)
    #IMPORTANT!!! Correlation plot for Hg and DOM 
    ggplot(inlet, aes(labile_m, THGTOC_m))+
      geom_point(size=6)+
      geom_smooth(method = "lm", se = FALSE, colour="black")
      facet_grid(. ~ factor(Station), scales="free")
      xlim(4, 6)
      
      inlet <- subset(dx, Station == "Inlet")
      outlet <- subset(dx, Station == "Outlet")
    head(dx)
      #Correlation analysis
      library(dplyr)
      b <- select(dx, TOC_m, THg_m, MeHg_m, sUVa_m, sVISa_m, SAR_m, THg_m, labile_m, THGTOC_m, MeHGTOC_m)
      library(Hmisc)
      rcorr(as.matrix(b), type="pearson")
      class(d)
      library("PerformanceAnalytics")
      chart.Correlation(b, histogram=TRUE, pch=19)
      head(d)
      
      
      #MAKKING THE CORRELATION ASSESSMENT
      library(tidyverse)
      library(ggpubr)
      theme_set(theme_pubr())
      ggplot(outlet, aes(x = SAR_m, y = THGTOC_m)) +
        geom_point() +
        stat_smooth()+
        stat_smooth(method = lm)
      
model <- lm(THGTOC_m ~ sVISa_m, data = dx)
model  
summary(model)



#STATISTICAL TESTING
res.aov <- aov(THGTOC_m ~ Station, data = dx)
# Summary of the analysis
summary(res.aov)
TukeyHSD(res.aov)







#Correlation with SENSOR LAKE DATA
dy <- read.table("Langtjern_weather.txt", sep = "\t", header = TRUE) #load data
dy$Date <- as.Date(dy$SampleDate,format = "%d.%m.%Y") #convert to date column
df <- dy[ -c(1:5) ] #removed uneccesary columns
head(df)

#to make monthly summaries
dff = df %>%
  mutate(month = format(Date, "%m"), year = format(Date, "%Y")) %>%
  group_by(month, year) %>%
  summarise(sun = mean(Straaling),
            airT = mean(AirTemp),
            Prec = mean(Precip),
            Hum = mean(Humidity))

plot(dff)
head(dff)
#Aggreger per dag
library(dplyr)
(out <- df %>%
    group_by(Date) %>%
    summarize(Sun=sum(Straaling), 
              Precip=sum(Precip),
              Precip_ave=mean(Precip),
              AirTemp=mean(AirTemp),
              Humidity = mean(Humidity)))

head(df)

#PLOTTING with time on x-axis and year-facets
ggplot(out)+
  geom_point(aes(x=Date, y=Precip), shape=16, size=5)
  geom_smooth(aes(x=Date, y=Precip), shape=16, size=2)+
  scale_x_date(labels = date_format("%b"),breaks = date_breaks("2 months"))+
  facet_grid(.~year(dx$Date), scales="free_x")+
  theme_bw()
ylim(2.5, 6)
scale_y_continuous(limit=c(3, 4))
geom_point(aes(x=Date, y=labile_s, colour=Station), shape=17, size=5)+
  head(dx)






ou <- head(out)
dfff <- na.omit(dff)
head(dfff)
ou = dfff
nrow(sun)
head(ou)
#Make indivudual datafiles as ts with correct frequency
sun <- ts(ou$sun, frequency=12, start=2016, end=2019)
pre <- ts(ou$Prec, frequency=12, start=2016, end=2019)
airT <- ts(ou$airT, frequency=12, start=2016, end=2019)
Humi <- ts(ou$Hum, frequency=12, start=2016, end=2019)

plot(sunny)
sunny <- decompose(sun)
precip <- decompose(pre)
AirTemp <- decompose(airT)
Humidity <- decompose(Humi)
plot(Humidity)
plot(AirTemp)
plot(precip)
plot(sunny)
ts.plot(pre)

#then YOU CAN SUBTRACT E.G. THE SEAOSNAL COMPONENT FROM THE DATA
birthsSeasonAdj <- sun - sunny$seasonal- sunny$random
plot.ts(birthsSeasonAdj)

#Make correspodning individual ts with correct frequency
#here we have inlet and outlet. can look at these individually and at the difference bwteen the two
newdata <- subset(dx,  Station =="Outlet")
sUVa <- na.omit(newdata$sUVa_m)
sUVaTS <- ts(sUVa, frequency=365, start=2016, end=2019)

decomsUVa <- decompose(sUVaTS)
plot(decomsUVa)

suva <- sUVaTS - decomsUVa$seasonal - decomsUVa$random
plot.ts(suva)
plot(suva~birthsSeasonAdj)

abline(lm(suva~birthsSeasonAdj))

ab <- lm(suva~birthsSeasonAdj)
summary(ab)

#What about doing monthly aggregates???








#PLoT vÃ¦rdata med eventuelt langtjern data
ggplot()+
  geom_smooth(dx, mapping=aes(x=Date, y=Precip), shape=16, size=2)+
  geom_point(dx, mapping=aes(x=Date, y=TOC_m, colour=Station), shape=16, size=3)
  scale_x_date(labels = date_format("%b"),breaks = date_breaks("2 months"))+
  scale_y_continuous(name = "Radiation", 
                     sec.axis = sec_axis(~.*10, name = "TOC"))
  facet_grid(.~year, scales="free_x")+
  theme_bw()
  

linearMod <- lm(_m ~ TOC_m, data=dx)
print(linearMod)
summary(linearMod)
